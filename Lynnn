#!/bin/bash

# Pterodactyl Panel Themer - Simple Login Page Changer
# By: Assistant
# Version: 1.0

# Warna untuk output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Fungsi untuk menampilkan pesan
print_message() {
    echo -e "${BLUE}[Pterodactyl Themer]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Fungsi untuk mengecek apakah script dijalankan sebagai root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        print_error "Script ini harus dijalankan sebagai root (gunakan sudo)"
        exit 1
    fi
}

# Fungsi untuk mengecek apakah Pterodactyl terinstall
check_pterodactyl() {
    if [ ! -d "/var/www/pterodactyl" ]; then
        print_error "Direktori Pterodactyl tidak ditemukan di /var/www/pterodactyl"
        print_error "Pastikan Pterodactyl sudah terinstall dengan benar"
        exit 1
    fi
}

# Fungsi untuk backup file asli
backup_files() {
    print_message "Membuat backup file asli..."
    
    local backup_dir="/root/pterodactyl_backup_$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$backup_dir"
    
    if [ -f "/var/www/pterodactyl/resources/views/auth/index.blade.php" ]; then
        cp "/var/www/pterodactyl/resources/views/auth/index.blade.php" "$backup_dir/index.blade.php.bak"
        print_success "Backup created: $backup_dir/index.blade.php.bak"
    else
        print_warning "File index.blade.php tidak ditemukan"
    fi
    
    echo "$backup_dir" > /tmp/pterodactyl_last_backup.txt
}

# Fungsi untuk restore file asli
restore_files() {
    print_message "Mencari backup terakhir..."
    
    if [ -f "/tmp/pterodactyl_last_backup.txt" ]; then
        local backup_dir=$(cat /tmp/pterodactyl_last_backup.txt)
        
        if [ -f "$backup_dir/index.blade.php.bak" ]; then
            cp "$backup_dir/index.blade.php.bak" "/var/www/pterodactyl/resources/views/auth/index.blade.php"
            print_success "File berhasil direstore dari: $backup_dir"
            
            # Clear cache
            cd /var/www/pterodactyl
            php artisan view:clear
            php artisan cache:clear
            
            print_success "Cache telah dibersihkan"
        else
            print_error "File backup tidak ditemukan di $backup_dir"
        fi
    else
        print_error "Tidak ada informasi backup yang ditemukan"
    fi
}

# Fungsi untuk membersihkan cache
clear_cache() {
    print_message "Membersihkan cache..."
    
    cd /var/www/pterodactyl
    php artisan view:clear
    php artisan cache:clear
    
    print_success "Cache berhasil dibersihkan"
}

# Fungsi untuk mengubah tampilan login
change_login_theme() {
    print_message "Mengubah tampilan login page..."
    
    # Path ke file blade template
    local blade_file="/var/www/pterodactyl/resources/views/auth/index.blade.php"
    
    # Kode HTML baru
    cat > "$blade_file" << 'EOF'
@extends('layouts.auth')

@section('title')
    Login
@endsection

@section('content')
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport" />
    <title>
      Pterodactyl
    </title>
    <link rel="icon" type="image/x-icon" href="https://pterodactyl.io/logos/pterry.svg" />
    <script src="https://cdn.tailwindcss.com">
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Roboto&amp;display=swap" rel="stylesheet" />
    <style>
      .custom-font { font-size: 14px; }  
    .custom-border { border: 1.9px solid #D1D5DB; }  
    body {  
      min-height: 100dvh;  
      overflow-y: auto;  
      font-family: 'Roboto', sans-serif;  
      background-color: #374150;  
    }  

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #374151;
      z-index: -1;
    }

    h2 { font-weight: 400; }

    .animate-spin-slow {
      animation: spin 1.2s linear infinite;
      border-top-color: #374150;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    </style>
  </head>
  <body class="bg-[#374151] flex flex-col items-center justify-start pt-[1px] min-h-[120dvh]">
    <h2 class="text-center text-white text-3xl mb-[6px] mt-20">
      Login to Continue
    </h2>
    <div class="w-full max-w-sm bg-white rounded-lg shadow-lg p-7 flex flex-col items-center" style="max-height:calc(99vh - 60px);">
      <div class="flex justify-center mb-7">
        <img alt="Pterodactyl logo" class="w-48 h-48 object-contain" src="https://pterodactyl.io/logos/pterry.svg" />
      </div>
      <form id="loginForm" class="w-full" method="POST" action="{{ route('auth.login') }}">
        @csrf
        <p class="text-gray-700 text-xs px-1 py-0 mb-1 font-medium">
          USERNAME OR EMAIL
        </p>
        <input id="username" name="user" class="w-full rounded-md px-3 py-3 mb-4 text-base text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 custom-border" type="text" required="" />
        <p class="text-gray-700 text-xs px-1 py-0 mb-1 font-medium">
          PASSWORD
        </p>
        <input id="password" name="password" class="w-full rounded-md px-3 py-3 mb-6 text-base text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 custom-border" type="password" required="" />
        <button id="loginBtn" type="submit" class="w-full bg-[#3b82f6] hover:bg-[#2563eb] text-white font-light py-4 rounded-[3px] transition-colors duration-200 custom-font flex justify-center items-center gap-2 relative overflow-hidden">
          <span id="loginText">LOGIN</span>
          <div id="miniSpinner" class="hidden absolute w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin">
          </div>
        </button>
      </form>
      <div class="text-center mt-[12px]">
        <a class="text-xs text-gray-500 hover:text-gray-700" href="#">FORGOT PASSWORD?</a>
      </div>
    </div>
    <p class="text-center text-xs mt-3 mb-0 select-none text-gray-400">
      © 2015 - 2025 Pterodactyl Software
    </p>
    <div id="spinner-bg" class="fixed inset-0 bg-[#374151] bg-opacity-100 z-50 hidden flex items-center justify-center" style="align-items: flex-start;">
      <div class="animate-spin-slow rounded-full h-16 w-16 border-8 border-gray-300 border-t-gray-600 mt-[12vh]">
      </div>
    </div>
    <script src="https://www.google.com/recaptcha/api.js?render=6LceAZIrAAAAACaj77El6PubR6nAPpARAA1TUDCL" async="" defer="">
    </script>
    <script>
      window.addEventListener("load", () => {
      if (typeof grecaptcha !== "undefined") {
        grecaptcha.ready(() => {
          grecaptcha.execute('6LceAZIrAAAAACaj77El6PubR6nAPpARAA1TUDCL', {action: 'login'}).then(token => {
            console.log('Decorative token:', token);
          });
        });
      }
    });

    document.getElementById("loginBtn")?.addEventListener("click", function(e) {
      const loginBtn = document.getElementById("loginBtn");
      const loginText = document.getElementById("loginText");
      const miniSpinner = document.getElementById("miniSpinner");
      const spinner = document.getElementById("spinner-bg");

      loginBtn.disabled = true;
      loginBtn.classList.add("bg-blue-400");
      loginBtn.classList.remove("hover:bg-[#2563eb]");
      loginText.classList.add("invisible");
      miniSpinner.classList.remove("hidden");
      
      setTimeout(() => {
        spinner.classList.remove("hidden");
      }, 500);
    });
    </script>
  </body>
</html>
@endsection
EOF
    
    if [ $? -eq 0 ]; then
        print_success "File berhasil diubah"
    else
        print_error "Gagal mengubah file"
        exit 1
    fi
}

# Fungsi untuk setup otomatis
auto_setup() {
    print_message "Memulai setup otomatis..."
    
    # Backup
    backup_files
    
    # Ubah theme
    change_login_theme
    
    # Clear cache
    clear_cache
    
    # Set permissions
    print_message "Mengatur permissions..."
    chown -R www-data:www-data /var/www/pterodactyl/storage /var/www/pterodactyl/bootstrap/cache
    chmod -R 755 /var/www/pterodactyl/storage /var/www/pterodactyl/bootstrap/cache
    
    print_success "Setup otomatis selesai!"
    print_message "Silahkan cek panel Anda sekarang"
}

# Fungsi untuk reset ke tampilan default
reset_to_default() {
    print_message "Mereset ke tampilan default Pterodactyl..."
    
    # Cek apakah ada file backup
    if [ -f "/tmp/pterodactyl_last_backup.txt" ]; then
        restore_files
    else
        # Jika tidak ada backup, restore dari template default
        print_warning "Tidak ada backup ditemukan, mencoba restore dari template default..."
        
        cd /var/www/pterodactyl
        php artisan vendor:publish --tag=laravel-views --force
        
        clear_cache
        
        print_success "Restore default selesai"
    fi
}

# Fungsi untuk menampilkan menu
show_menu() {
    echo ""
    echo -e "${BLUE}╔══════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║   PTERODACTYL PANEL THEMER          ║${NC}"
    echo -e "${BLUE}╠══════════════════════════════════════╣${NC}"
    echo -e "${BLUE}║${NC}  1. Setup Otomatis (Baru/New)       ${BLUE}║${NC}"
    echo -e "${BLUE}║${NC}  2. Pulihkan ke Tampilan Default    ${BLUE}║${NC}"
    echo -e "${BLUE}║${NC}  3. Backup Manual                    ${BLUE}║${NC}"
    echo -e "${BLUE}║${NC}  4. Restore dari Backup              ${BLUE}║${NC}"
    echo -e "${BLUE}║${NC}  5. Clear Cache                      ${BLUE}║${NC}"
    echo -e "${BLUE}║${NC}  6. Keluar                           ${BLUE}║${NC}"
    echo -e "${BLUE}╚══════════════════════════════════════╝${NC}"
    echo ""
    read -p "Pilih menu [1-6]: " menu_option
    echo ""
}

# Main script
main() {
    clear
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}   PTERODACTYL PANEL THEMER SCRIPT    ${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo ""
    
    check_root
    check_pterodactyl
    
    while true; do
        show_menu
        
        case $menu_option in
            1)
                auto_setup
                ;;
            2)
                reset_to_default
                ;;
            3)
                backup_files
                print_success "Backup manual selesai"
                ;;
            4)
                restore_files
                ;;
            5)
                clear_cache
                ;;
            6)
                print_message "Terima kasih telah menggunakan script ini"
                exit 0
                ;;
            *)
                print_error "Pilihan tidak valid"
                ;;
        esac
        
        echo ""
        read -p "Tekan Enter untuk melanjutkan..."
    done
}

# Jalankan main function
main
